# Manual trigger only
trigger: none
pr: none

parameters:
- name: buildAgentPoolVar
  displayName: 'Build agent pool'
  type: string
  default: 'BuildAgentPool'
- name: buildAgentVmImageVar
  displayName: 'Build agent image'
  type: string
  default: 'BuildAgentImage'
- name: ghRelease
  displayName: 'Draft github release'
  type: boolean
  default: false
- name: isPreRelease
  displayName: 'PreRelease / release candidate build'
  type: boolean
  default: false
- name: publishExt
  displayName: 'Publish to Marketplace'
  type: boolean
  default: false

variables:
- template: common/variables.yml
- name: vmImage
  value: $[variables.${{ parameters.buildAgentVmImageVar }}]
- name: buildPool
  value: $[variables.${{ parameters.buildAgentPoolVar }}]

stages:
- stage: test
  displayName: 'Test'
  jobs:
  - job: run_tests
    displayName: 'Run tests'
    strategy:
      matrix:
        linux:
          imageName: 'ubuntu-latest'
        mac:
          imageName: 'macos-latest'
        windows:
          imageName: 'windows-latest'
    pool:
      vmImage: $(imageName)
    steps:
      - template: common/setup_steps.yml
      - template: common/compile_steps.yml
      - template: common/check_steps.yml
      - template: common/test_steps.yml

- stage: build
  dependsOn: [test]
  jobs:
  - job: CredScan
    displayName: 'Credential Scan'
    pool:
      vmImage: windows-latest
    steps:
    - task: CredScan@3
      inputs:
        outputFormat: 'pre'
        scanFolder: '$(Build.SourcesDirectory)'

    - task: PostAnalysis@1
      inputs:
        AllTools: false
        APIScan: false
        BinSkim: false
        CodesignValidation: false
        CredScan: true
        FortifySCA: false
        FxCop: false
        ModernCop: false
        PoliCheck: false
        RoslynAnalyzers: false
        SDLNativeRules: false
        Semmle: false
        TSLint: false
        ToolLogsNotFoundAction: 'Standard'

  - job: build_and_package
    displayName: 'Build and Publish Artifacts'
    pool:
      name: $(buildPool)
      vmImage: $(vmImage)
      demands:
        - ImageOverride -equals $(vmImage)
    dependsOn: CredScan
    steps:
      - template: common/setup_steps.yml
      - template: common/compile_steps.yml
      - template: common/check_steps.yml
      - template: common/test_steps.yml

      # modify application insights key for releases
      - script: |
          node scripts/modifyPackageJson.js aiKey $ENV_AIKEY
        displayName: Modify package.json for releases
        condition: and(succeeded(), eq(${{ parameters.publishExt }}, True))
        env:
          ENV_AIKEY: $(PROD_AIKEY)

      - template: common/package_steps.yml
      
      - task: PowerShell@2
        name: 'getVersion'
        condition: eq(${{ parameters.ghRelease }}, true)
        displayName: Scrape tag from package.json
        inputs:
          targetType: inline
          script: |
            $packageVersion = npm version | ConvertFrom-Json | Select-Object -ExpandProperty {vscode-dtdl}
            echo "##vso[task.setvariable variable=versionTag;isOutput=true]v$packageVersion"

- stage: release
  displayName: 'Release to Github and VS Marketplace'
  dependsOn: [test, build]
  pool:
    name: $(buildPool)
    vmImage: $(vmImage)
    demands:
      - ImageOverride -equals $(vmImage)
  jobs:
  - deployment: 'StageRelease'
    displayName: 'Stage Release for deployment'
    environment: 'production'
  - job: 'release'
    displayName: 'Release package'
    variables:
      versionTag: $[ stageDependencies.build.build_and_package.outputs['getVersion.versionTag'] ]
    steps:
      - task: DownloadPipelineArtifact@2
        displayName : 'Download VSIX Build Artifacts'
        inputs:
          source: 'current'
          artifact: 'vscode-dtdl'
          path: '$(System.ArtifactsDirectory)/vsix'

      - task: GitHubRelease@1
        displayName: 'Deploy Release to GitHub'
        inputs:
          gitHubConnection: $(GithubReleaseConnection)
          repositoryName: '$(Build.Repository.Name)'
          action: 'create'
          tagSource: userSpecifiedTag
          title: Release $(versionTag)
          tag: $(versionTag)
          isDraft: true
          isPreRelease: ${{ parameters.isPreRelease }}
          assets: '$(System.ArtifactsDirectory)/vsix/*.vsix'
        condition: and(succeeded(), eq(${{ parameters.ghRelease }}, true))

      # publish pre-release vsix to marketplace
      - bash: |
          vsce publish -p $MARKETPLACE_TOKEN --packagePath *.vsix --pre-release
        workingDirectory: '$(System.ArtifactsDirectory)/vsix'
        displayName: Deploy pre-release VSIX to marketplace
        condition: and(succeeded(), eq(${{ parameters.publishExt }}, True), eq(${{ parameters.isPreRelease }}, True))
        env:
          MARKETPLACE_TOKEN: $(vsciot_marketplace_token)

      # publish vsix to marketplace
      - bash: |
          vsce publish -p $MARKETPLACE_TOKEN --packagePath *.vsix
        workingDirectory: '$(System.ArtifactsDirectory)/vsix'
        displayName: Deploy release VSIX to marketplace
        condition: and(succeeded(), eq(${{ parameters.publishExt }}, True), eq(${{ parameters.isPreRelease }}, False))
        env:
          MARKETPLACE_TOKEN: $(vsciot_marketplace_token)